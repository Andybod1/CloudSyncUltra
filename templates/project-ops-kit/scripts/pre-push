#!/bin/bash

# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  CloudSync Ultra - Pre-push Hook                                           ║
# ║  Runs full test suite before pushing to remote                             ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
#
# This hook runs automatically before git push.
# It ensures tests pass before code reaches the remote.
#
# Install: ./scripts/install-hooks.sh
# Bypass (emergency only): git push --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

cd "$PROJECT_ROOT"

echo ""
echo -e "${BLUE}${BOLD}┌─────────────────────────────────────────┐${NC}"
echo -e "${BLUE}${BOLD}│     Pre-push Quality Gate               │${NC}"
echo -e "${BLUE}${BOLD}└─────────────────────────────────────────┘${NC}"
echo ""

ERRORS=0

# ─────────────────────────────────────────────────────────────────────────────
# Check 1: Build
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[1/3]${NC} Building project..."

if xcodebuild -scheme CloudSyncApp -configuration Debug build -quiet 2>/dev/null; then
    echo -e "  ${GREEN}✓${NC} Build succeeded"
else
    echo -e "  ${RED}✗${NC} Build failed"
    ERRORS=$((ERRORS + 1))
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 2: Run Tests
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[2/3]${NC} Running tests..."

TEST_OUTPUT=$(xcodebuild test \
    -scheme CloudSyncApp \
    -destination 'platform=macOS' \
    -quiet 2>&1) || true

if echo "$TEST_OUTPUT" | grep -q "TEST SUCCEEDED\|Test session results"; then
    PASSED=$(echo "$TEST_OUTPUT" | grep -o "[0-9]* test" | head -1 || echo "? tests")
    echo -e "  ${GREEN}✓${NC} Tests passed ($PASSED)"
else
    echo -e "  ${RED}✗${NC} Tests failed"
    echo "$TEST_OUTPUT" | grep -E "(failed|error:)" | head -5
    ERRORS=$((ERRORS + 1))
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 3: Version consistency
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[3/3]${NC} Checking version consistency..."

if [[ -x "./scripts/version-check.sh" ]]; then
    if ./scripts/version-check.sh > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Versions aligned"
    else
        echo -e "  ${YELLOW}⚠${NC} Version mismatch (run ./scripts/update-version.sh)"
    fi
else
    echo -e "  ${YELLOW}⚠${NC} version-check.sh not found"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Summary
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo -e "${BLUE}${BOLD}─────────────────────────────────────────${NC}"

if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}${BOLD}✗ PUSH BLOCKED${NC}"
    echo -e "  ${RED}$ERRORS check(s) failed - fix before pushing${NC}"
    echo ""
    echo -e "  To bypass (emergency only): ${YELLOW}git push --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}${BOLD}✓ PUSH ALLOWED${NC}"
    echo ""
fi
