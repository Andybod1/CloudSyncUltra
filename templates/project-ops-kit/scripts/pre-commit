#!/bin/bash

# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  Project Ops Kit - Pre-commit Hook                                         ║
# ║  Catches errors BEFORE they reach the repo                                 ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
#
# This hook runs automatically before each commit.
# If any check fails, the commit is rejected.
#
# Install: ./scripts/install-hooks.sh
# Bypass (emergency only): git commit --no-verify

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

cd "$PROJECT_ROOT"

echo ""
echo -e "${BLUE}${BOLD}┌─────────────────────────────────────────┐${NC}"
echo -e "${BLUE}${BOLD}│     Pre-commit Quality Gate             │${NC}"
echo -e "${BLUE}${BOLD}└─────────────────────────────────────────┘${NC}"
echo ""

ERRORS=0
WARNINGS=0

# ─────────────────────────────────────────────────────────────────────────────
# Check 1: Swift files syntax check (fast)
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[1/5]${NC} Checking Swift syntax..."

# Get staged Swift files
STAGED_SWIFT=$(git diff --cached --name-only --diff-filter=ACM | grep "\.swift$" || true)

if [[ -n "$STAGED_SWIFT" ]]; then
    SYNTAX_ERRORS=0
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            # Quick syntax check using swiftc -parse
            if ! swiftc -parse "$file" 2>/dev/null; then
                echo -e "  ${RED}✗${NC} Syntax error: $file"
                SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
            fi
        fi
    done <<< "$STAGED_SWIFT"
    
    if [[ $SYNTAX_ERRORS -eq 0 ]]; then
        echo -e "  ${GREEN}✓${NC} Swift syntax OK ($(echo "$STAGED_SWIFT" | wc -l | tr -d ' ') files)"
    else
        echo -e "  ${RED}✗${NC} $SYNTAX_ERRORS syntax errors found"
        ERRORS=$((ERRORS + SYNTAX_ERRORS))
    fi
else
    echo -e "  ${GREEN}✓${NC} No Swift files staged"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 2: Build check (critical)
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[2/5]${NC} Building project..."

# Run build check if source files changed
# TODO: Customize this for your project's build system
# Examples:
#   xcodebuild build -project YourApp.xcodeproj -scheme YourApp
#   npm run build
#   cargo build
#   go build ./...
if [[ -n "$STAGED_SWIFT" ]]; then
    echo -e "  ${YELLOW}⚠${NC} Configure build command for your project"
    echo -e "  ${GREEN}✓${NC} Build check placeholder (customize in pre-commit)"
else
    echo -e "  ${GREEN}✓${NC} Skipped (no source changes)"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 3: Version consistency
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[3/5]${NC} Checking version consistency..."

if [[ -x "./scripts/version-check.sh" ]]; then
    if ./scripts/version-check.sh > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Versions aligned"
    else
        echo -e "  ${YELLOW}⚠${NC} Version mismatch (run ./scripts/version-check.sh)"
        WARNINGS=$((WARNINGS + 1))
    fi
else
    echo -e "  ${YELLOW}⚠${NC} version-check.sh not found"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 4: No debug code left behind
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[4/5]${NC} Checking for debug artifacts..."

DEBUG_PATTERNS=(
    "print(\"DEBUG"
    "// TODO: REMOVE"
    "// FIXME: BEFORE COMMIT"
    "fatalError(\"DEBUG"
    "\.debug\s*=\s*true"
)

DEBUG_FOUND=0
for pattern in "${DEBUG_PATTERNS[@]}"; do
    if [[ -n "$STAGED_SWIFT" ]]; then
        MATCHES=$(echo "$STAGED_SWIFT" | xargs grep -l "$pattern" 2>/dev/null || true)
        if [[ -n "$MATCHES" ]]; then
            echo -e "  ${YELLOW}⚠${NC} Found '$pattern' in:"
            echo "$MATCHES" | sed 's/^/      /'
            DEBUG_FOUND=$((DEBUG_FOUND + 1))
        fi
    fi
done

if [[ $DEBUG_FOUND -eq 0 ]]; then
    echo -e "  ${GREEN}✓${NC} No debug artifacts"
else
    WARNINGS=$((WARNINGS + DEBUG_FOUND))
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check 5: Large files check
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${BLUE}[5/5]${NC} Checking for large files..."

LARGE_FILES=$(git diff --cached --name-only | while read file; do
    if [[ -f "$file" ]]; then
        SIZE=$(wc -c < "$file" | tr -d ' ')
        if [[ $SIZE -gt 1048576 ]]; then  # 1MB
            echo "$file ($((SIZE / 1024))KB)"
        fi
    fi
done)

if [[ -n "$LARGE_FILES" ]]; then
    echo -e "  ${YELLOW}⚠${NC} Large files (>1MB):"
    echo "$LARGE_FILES" | sed 's/^/      /'
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "  ${GREEN}✓${NC} No large files"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Summary
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo -e "${BLUE}${BOLD}─────────────────────────────────────────${NC}"

if [[ $ERRORS -gt 0 ]]; then
    echo -e "${RED}${BOLD}✗ COMMIT BLOCKED${NC}"
    echo -e "  ${RED}$ERRORS error(s) must be fixed${NC}"
    if [[ $WARNINGS -gt 0 ]]; then
        echo -e "  ${YELLOW}$WARNINGS warning(s)${NC}"
    fi
    echo ""
    echo -e "${YELLOW}Fix errors and try again.${NC}"
    echo -e "${YELLOW}Emergency bypass: git commit --no-verify${NC}"
    echo ""
    exit 1
elif [[ $WARNINGS -gt 0 ]]; then
    echo -e "${YELLOW}${BOLD}⚠ COMMIT ALLOWED (with warnings)${NC}"
    echo -e "  ${YELLOW}$WARNINGS warning(s) - consider fixing${NC}"
    echo ""
else
    echo -e "${GREEN}${BOLD}✓ ALL CHECKS PASSED${NC}"
    echo ""
fi

exit 0
