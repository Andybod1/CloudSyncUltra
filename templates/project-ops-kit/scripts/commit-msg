#!/bin/bash
#
# Git commit-msg hook - validates conventional commit format
#
# Install: cp scripts/commit-msg .git/hooks/ && chmod +x .git/hooks/commit-msg
#

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Skip merge commits
if [[ "$COMMIT_MSG" =~ ^Merge ]]; then
    exit 0
fi

# Conventional commit pattern: type(scope)?: description
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?\!?: .+"

if [[ "$COMMIT_MSG" =~ $PATTERN ]]; then
    echo -e "${GREEN}✓${NC} Commit message follows conventional format"
    exit 0
else
    echo ""
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo ""
    echo "Your message:"
    echo "  $COMMIT_MSG"
    echo ""
    echo "Expected format:"
    echo -e "  ${YELLOW}type(scope): description${NC}"
    echo ""
    echo "Valid types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation only"
    echo "  style    - Formatting, no code change"
    echo "  refactor - Code change, no feature/fix"
    echo "  perf     - Performance improvement"
    echo "  test     - Adding tests"
    echo "  build    - Build system changes"
    echo "  ci       - CI configuration"
    echo "  chore    - Maintenance tasks"
    echo "  revert   - Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  feat(auth): add OAuth login support"
    echo "  fix: resolve crash on startup"
    echo "  docs: update README installation steps"
    echo ""
    echo -e "${RED}✗ Commit rejected. Fix the message format and try again.${NC}"
    echo -e "${YELLOW}Bypass (emergency only): git commit --no-verify${NC}"
    exit 1
fi
