name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-14

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v6

      # Setup environment
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install rclone
        run: brew install rclone

      - name: Install SwiftLint
        run: brew install swiftlint

      # Run SwiftLint
      - name: SwiftLint
        run: |
          echo "ðŸ“ Running SwiftLint..."
          LINT_RESULT=$(swiftlint lint --reporter github-actions-logging 2>&1) || true
          echo "$LINT_RESULT"

          # Count errors (serious violations)
          ERROR_COUNT=$(echo "$LINT_RESULT" | grep -c "error:" || echo "0")
          WARNING_COUNT=$(echo "$LINT_RESULT" | grep -c "warning:" || echo "0")

          echo ""
          echo "ðŸ“Š SwiftLint Results: $ERROR_COUNT errors, $WARNING_COUNT warnings"

          # Fail only on errors, not warnings
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ SwiftLint found $ERROR_COUNT error(s) - these should be fixed"
            # Currently non-blocking while codebase is cleaned up
            # TODO: Enable strict mode once violations are fixed
            # exit 1
          fi
          echo "âœ… SwiftLint check complete"

      # Cache DerivedData for faster builds
      - name: Cache DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      # Install xcpretty if not available
      - name: Install xcpretty
        run: |
          if ! command -v xcpretty &> /dev/null; then
            gem install xcpretty
          fi

      # Build the project
      - name: Build
        run: |
          xcodebuild build \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            | xcpretty

      # Run tests with code coverage
      - name: Run Tests with Coverage
        run: |
          xcodebuild test \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults \
            | xcpretty --report junit --output build/reports/junit.xml

      # Extract and report code coverage (non-blocking)
      - name: Generate Coverage Report
        continue-on-error: true
        run: |
          # Find the xcresult bundle
          RESULT_BUNDLE="TestResults.xcresult"
          
          if [ -d "$RESULT_BUNDLE" ]; then
            echo "ðŸ“Š Code Coverage Report"
            echo "========================"
            
            # Get coverage percentage (may fail if no coverage data)
            if xcrun xccov view --report --only-targets "$RESULT_BUNDLE" > coverage_report.txt 2>&1; then
              # Display coverage summary
              cat coverage_report.txt
              
              # Extract overall coverage percentage for CloudSyncApp target
              COVERAGE=$(grep "CloudSyncApp.app" coverage_report.txt | awk '{print $4}' | tr -d '%' || echo "")
              
              if [ ! -z "$COVERAGE" ]; then
                echo ""
                echo "ðŸ“ˆ CloudSyncApp Coverage: ${COVERAGE}%"
                
                # Save coverage to file for artifact
                echo "$COVERAGE" > coverage_percentage.txt
                
                # Check threshold (80% for Quality++)
                THRESHOLD=80
                COVERAGE_INT=${COVERAGE%.*}
                if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
                  echo "âš ï¸ Coverage ($COVERAGE%) is below target ($THRESHOLD%)"
                  # Warning only - not blocking until coverage improves
                else
                  echo "âœ… Coverage ($COVERAGE%) meets target ($THRESHOLD%)"
                fi
              else
                echo "âš ï¸ Could not extract coverage percentage"
              fi
            else
              echo "âš ï¸ Coverage data not available in result bundle"
              echo "   This can happen if code coverage collection failed during test run"
              cat coverage_report.txt 2>/dev/null || true
            fi
          else
            echo "âš ï¸ No test results found at $RESULT_BUNDLE"
          fi

      # Generate detailed coverage JSON (non-blocking)
      - name: Generate Coverage JSON
        if: always()
        continue-on-error: true
        run: |
          RESULT_BUNDLE="TestResults.xcresult"
          if [ -d "$RESULT_BUNDLE" ]; then
            xcrun xccov view --report --json "$RESULT_BUNDLE" > coverage.json 2>&1 || echo "{}" > coverage.json
          fi

      # Check version consistency
      - name: Version Check
        run: |
          chmod +x ./scripts/version-check.sh
          ./scripts/version-check.sh

      # Upload test results and coverage
      - name: Upload Test Results & Coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: |
            build/reports/
            TestResults.xcresult/
            coverage_report.txt
            coverage_percentage.txt
            coverage.json
          retention-days: 14

      # Post coverage summary to PR (if PR)
      - name: Coverage Summary
        if: github.event_name == 'pull_request'
        run: |
          if [ -f coverage_percentage.txt ]; then
            COVERAGE=$(cat coverage_percentage.txt)
            echo "### ðŸ“Š Code Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See artifacts for detailed coverage report." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Code Coverage: Not Available" >> $GITHUB_STEP_SUMMARY
          fi

  # Binary Size Tracking
  binary-size:
    name: Binary Size
    runs-on: macos-14
    needs: build-and-test

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install rclone
        run: brew install rclone

      - name: Cache DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Build Release
        run: |
          xcodebuild build \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            -quiet

      - name: Measure Binary Size
        id: size
        run: |
          APP_PATH=$(find build -name "CloudSyncApp.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ Could not find CloudSyncApp.app"
            exit 1
          fi

          # Get size in bytes
          SIZE_BYTES=$(du -sk "$APP_PATH" | cut -f1)
          SIZE_KB=$SIZE_BYTES
          SIZE_MB=$(echo "scale=2; $SIZE_KB / 1024" | bc)

          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ App Size: ${SIZE_MB} MB (${SIZE_KB} KB)"

      - name: Compare with Baseline
        id: compare
        run: |
          CURRENT_KB=${{ steps.size.outputs.size_kb }}
          BASELINE_FILE=".claude-team/metrics/binary-size-baseline.txt"

          if [ -f "$BASELINE_FILE" ]; then
            BASELINE_KB=$(cat "$BASELINE_FILE" | tr -d '[:space:]')
            DIFF=$((CURRENT_KB - BASELINE_KB))
            PCT_CHANGE=$(echo "scale=1; ($DIFF * 100) / $BASELINE_KB" | bc)

            echo "baseline_kb=$BASELINE_KB" >> $GITHUB_OUTPUT
            echo "diff_kb=$DIFF" >> $GITHUB_OUTPUT
            echo "pct_change=$PCT_CHANGE" >> $GITHUB_OUTPUT

            echo "ðŸ“Š Baseline: ${BASELINE_KB} KB"
            echo "ðŸ“Š Current:  ${CURRENT_KB} KB"
            echo "ðŸ“Š Change:   ${DIFF} KB (${PCT_CHANGE}%)"

            # Warn if size increased by more than 10%
            if [ "$DIFF" -gt 0 ]; then
              THRESHOLD=10
              PCT_INT=${PCT_CHANGE%.*}
              if [ "${PCT_INT:-0}" -gt "$THRESHOLD" ]; then
                echo "âš ï¸ Binary size increased by more than ${THRESHOLD}%!"
                echo "bloat=true" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "ðŸ“ No baseline found - this is the first measurement"
            echo "baseline_kb=0" >> $GITHUB_OUTPUT
          fi

      - name: Binary Size Summary
        run: |
          SIZE_MB=${{ steps.size.outputs.size_mb }}
          BASELINE_KB=${{ steps.compare.outputs.baseline_kb }}
          DIFF_KB=${{ steps.compare.outputs.diff_kb }}
          PCT=${{ steps.compare.outputs.pct_change }}

          echo "### ðŸ“¦ Binary Size: ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$BASELINE_KB" != "0" ] && [ -n "$BASELINE_KB" ]; then
            if [ "${DIFF_KB:-0}" -gt 0 ]; then
              echo "âš ï¸ **+${DIFF_KB} KB (+${PCT}%)** from baseline" >> $GITHUB_STEP_SUMMARY
            elif [ "${DIFF_KB:-0}" -lt 0 ]; then
              echo "âœ… **${DIFF_KB} KB (${PCT}%)** smaller than baseline" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No change from baseline" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ðŸ“ First measurement - no baseline to compare" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Save Size Artifact
        run: |
          mkdir -p metrics
          echo "${{ steps.size.outputs.size_kb }}" > metrics/binary-size.txt
          echo "{\"size_kb\": ${{ steps.size.outputs.size_kb }}, \"size_mb\": ${{ steps.size.outputs.size_mb }}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"commit\": \"${{ github.sha }}\"}" > metrics/binary-size.json

      - name: Upload Size Metrics
        uses: actions/upload-artifact@v6
        with:
          name: binary-size
          path: metrics/
          retention-days: 90

  # Memory Safety Check (ASan + TSan)
  memory-safety:
    name: Memory Safety
    runs-on: macos-14
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install rclone
        run: brew install rclone

      - name: Cache DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Run Address Sanitizer
        continue-on-error: true
        run: |
          echo "ðŸ” Running Address Sanitizer..."
          xcodebuild test \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            -skip-testing:CloudSyncAppUITests \
            -enableAddressSanitizer YES \
            -quiet 2>&1 | tee asan_output.txt || true

          if grep -q "AddressSanitizer" asan_output.txt; then
            echo "âš ï¸ Address Sanitizer found issues"
            grep -A 5 "AddressSanitizer" asan_output.txt | head -30
          else
            echo "âœ… No memory issues detected"
          fi

      - name: Run Thread Sanitizer
        continue-on-error: true
        run: |
          echo "ðŸ” Running Thread Sanitizer..."
          xcodebuild test \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            -skip-testing:CloudSyncAppUITests \
            -enableThreadSanitizer YES \
            -quiet 2>&1 | tee tsan_output.txt || true

          if grep -q "ThreadSanitizer" tsan_output.txt; then
            echo "âš ï¸ Thread Sanitizer found race conditions"
            grep -A 5 "ThreadSanitizer" tsan_output.txt | head -30
          else
            echo "âœ… No race conditions detected"
          fi

      - name: Memory Safety Summary
        run: |
          echo "### ðŸ§  Memory Safety Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "AddressSanitizer\|ThreadSanitizer" asan_output.txt tsan_output.txt 2>/dev/null; then
            echo "âš ï¸ Issues detected - review logs" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No memory or threading issues detected" >> $GITHUB_STEP_SUMMARY
          fi
