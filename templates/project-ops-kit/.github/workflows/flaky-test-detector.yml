name: Flaky Test Detector

on:
  schedule:
    # Run weekly on Sunday at 2am UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of test iterations'
        required: false
        default: '5'
        type: string

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  detect-flaky-tests:
    name: Detect Flaky Tests
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install Dependencies
        run: brew install rclone

      - name: Cache DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: flaky-${{ runner.os }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            flaky-${{ runner.os }}-

      - name: Run Flaky Test Detection
        id: flaky
        run: |
          ITERATIONS=${{ github.event.inputs.iterations || '5' }}
          echo "üîÑ Running tests $ITERATIONS times to detect flaky tests..."

          mkdir -p flaky-results

          FLAKY_TESTS=""
          TOTAL_TESTS=0
          PASSED_RUNS=0

          for i in $(seq 1 $ITERATIONS); do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "  Iteration $i of $ITERATIONS"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Run tests and capture output
            xcodebuild test \
              -project CloudSyncApp.xcodeproj \
              -scheme CloudSyncApp \
              -destination 'platform=macOS' \
              -skip-testing:CloudSyncAppUITests \
              -resultBundlePath "flaky-results/run-$i" \
              2>&1 | tee "flaky-results/output-$i.txt" || true

            # Extract test results
            if grep -q "TEST SUCCEEDED" "flaky-results/output-$i.txt"; then
              PASSED_RUNS=$((PASSED_RUNS + 1))
              echo "‚úÖ Run $i: PASSED"
            else
              echo "‚ùå Run $i: FAILED"

              # Extract failed test names
              FAILED=$(grep -oE "Test Case.*failed" "flaky-results/output-$i.txt" | sed 's/Test Case //' | sed 's/ failed//' || true)
              if [ -n "$FAILED" ]; then
                echo "Failed tests:"
                echo "$FAILED" | while read test; do
                  echo "  - $test"
                  # Track unique failures
                  if ! echo "$FLAKY_TESTS" | grep -q "$test"; then
                    FLAKY_TESTS="$FLAKY_TESTS$test\n"
                  fi
                done
              fi
            fi
          done

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Passed: $PASSED_RUNS / $ITERATIONS runs"

          # Calculate flakiness
          if [ "$PASSED_RUNS" -eq "$ITERATIONS" ]; then
            echo "‚úÖ No flaky tests detected"
            echo "flaky_count=0" >> $GITHUB_OUTPUT
            echo "status=stable" >> $GITHUB_OUTPUT
          elif [ "$PASSED_RUNS" -eq 0 ]; then
            echo "‚ùå All runs failed - likely a real bug, not flakiness"
            echo "flaky_count=0" >> $GITHUB_OUTPUT
            echo "status=broken" >> $GITHUB_OUTPUT
          else
            FLAKY_COUNT=$(echo -e "$FLAKY_TESTS" | grep -v "^$" | wc -l | tr -d ' ')
            echo "‚ö†Ô∏è Detected $FLAKY_COUNT potentially flaky test(s)"
            echo -e "$FLAKY_TESTS" | grep -v "^$" | while read test; do
              echo "  - $test"
            done
            echo "flaky_count=$FLAKY_COUNT" >> $GITHUB_OUTPUT
            echo "status=flaky" >> $GITHUB_OUTPUT

            # Save flaky test list
            echo -e "$FLAKY_TESTS" > flaky-results/flaky-tests.txt
          fi

      - name: Generate Report
        run: |
          STATUS=${{ steps.flaky.outputs.status }}
          FLAKY_COUNT=${{ steps.flaky.outputs.flaky_count }}

          echo "### üîç Flaky Test Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Iterations:** ${{ github.event.inputs.iterations || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$STATUS" in
            "stable")
              echo "‚úÖ **Status: STABLE** - No flaky tests detected" >> $GITHUB_STEP_SUMMARY
              ;;
            "flaky")
              echo "‚ö†Ô∏è **Status: FLAKY** - $FLAKY_COUNT test(s) showed inconsistent results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Potentially Flaky Tests:" >> $GITHUB_STEP_SUMMARY
              if [ -f flaky-results/flaky-tests.txt ]; then
                cat flaky-results/flaky-tests.txt | while read test; do
                  [ -n "$test" ] && echo "- \`$test\`" >> $GITHUB_STEP_SUMMARY
                done
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:** Investigate and fix these tests to improve reliability." >> $GITHUB_STEP_SUMMARY
              ;;
            "broken")
              echo "‚ùå **Status: BROKEN** - All test runs failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This indicates a real bug, not flakiness. Check the test output for details." >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Flaky tests are tests that sometimes pass and sometimes fail without code changes.*" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: flaky-test-results
          path: flaky-results/
          retention-days: 14

      - name: Fail on Flaky Tests
        if: steps.flaky.outputs.status == 'flaky'
        run: |
          echo "‚ö†Ô∏è Flaky tests detected - marking workflow as failed"
          echo "Please investigate and fix the flaky tests listed in the summary."
          exit 1
