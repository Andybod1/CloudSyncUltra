name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Check commit messages follow conventional commits
  commit-lint:
    name: Commit Message Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check Commit Messages
        run: |
          echo "üîç Checking commit messages for conventional format..."

          # Get commits in this PR
          COMMITS=$(git log --format="%s" origin/${{ github.base_ref }}..HEAD)

          ERRORS=0
          while IFS= read -r msg; do
            [[ -z "$msg" ]] && continue

            # Check conventional commit format: type(scope)?: description
            if [[ "$msg" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?\!?:\ .+ ]]; then
              echo "‚úÖ $msg"
            elif [[ "$msg" =~ ^Merge ]]; then
              echo "‚è≠Ô∏è $msg (merge commit, skipped)"
            else
              echo "‚ùå $msg"
              echo "   Expected format: type(scope): description"
              echo "   Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              ERRORS=$((ERRORS + 1))
            fi
          done <<< "$COMMITS"

          echo ""
          if [ "$ERRORS" -gt 0 ]; then
            echo "### ‚ùå Commit Lint Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$ERRORS commit(s) don't follow [Conventional Commits](https://www.conventionalcommits.org/)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Expected format:** \`type(scope): description\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert" >> $GITHUB_STEP_SUMMARY
            # Warning only - don't block PRs yet
            echo "‚ö†Ô∏è $ERRORS commit message(s) don't follow conventional format"
          else
            echo "### ‚úÖ Commit Lint Passed" >> $GITHUB_STEP_SUMMARY
            echo "All commits follow conventional format." >> $GITHUB_STEP_SUMMARY
          fi

  # Check PR size and warn if too large
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR Size
        id: size
        run: |
          # Get diff stats
          STATS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD)

          # Parse insertions and deletions
          INSERTIONS=$(echo "$STATS" | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(echo "$STATS" | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo "0")
          FILES=$(echo "$STATS" | grep -oE '[0-9]+ file' | grep -oE '[0-9]+' || echo "0")

          TOTAL=$((INSERTIONS + DELETIONS))

          echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "üìä PR Stats: +$INSERTIONS -$DELETIONS ($TOTAL lines) in $FILES files"

      - name: Size Summary
        run: |
          TOTAL=${{ steps.size.outputs.total }}
          FILES=${{ steps.size.outputs.files }}
          INSERTIONS=${{ steps.size.outputs.insertions }}
          DELETIONS=${{ steps.size.outputs.deletions }}

          # Determine size category
          if [ "$TOTAL" -lt 100 ]; then
            SIZE="XS"
            EMOJI="üü¢"
            MSG="Perfect size for quick review"
          elif [ "$TOTAL" -lt 300 ]; then
            SIZE="S"
            EMOJI="üü¢"
            MSG="Good size"
          elif [ "$TOTAL" -lt 500 ]; then
            SIZE="M"
            EMOJI="üü°"
            MSG="Consider splitting if possible"
          elif [ "$TOTAL" -lt 1000 ]; then
            SIZE="L"
            EMOJI="üü†"
            MSG="Large PR - review may take longer"
          else
            SIZE="XL"
            EMOJI="üî¥"
            MSG="Very large PR - strongly consider splitting"
          fi

          echo "### $EMOJI PR Size: $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | $FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| Insertions | +$INSERTIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| Deletions | -$DELETIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Lines** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$MSG" >> $GITHUB_STEP_SUMMARY

          # Size guide
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Size Guide</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Size | Lines | Review Time |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ XS | <100 | ~10 min |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ S | <300 | ~20 min |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° M | <500 | ~30 min |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† L | <1000 | ~1 hour |" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ XL | 1000+ | Consider splitting |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Check documentation links
  doc-links:
    name: Doc Link Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Documentation Links
        run: |
          echo "üîó Checking documentation links..."

          BROKEN=0
          CHECKED=0

          # Find all markdown files
          for file in $(find . -name "*.md" -type f \
              -not -path "./.git/*" \
              -not -path "./build/*" \
              -not -path "./DerivedData/*" \
              2>/dev/null); do

            # Extract relative links (not URLs, not anchors only, not images)
            LINKS=$(grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$file" 2>/dev/null | \
                    grep -oE '\]\([^)]+\)' | \
                    sed 's/\](//' | sed 's/)//' | \
                    grep -v '^http' | \
                    grep -v '^#' | \
                    grep -v '\.png$' | \
                    grep -v '\.jpg$' | \
                    grep -v '\.gif$' | \
                    grep -v '\.svg$' || true)

            [[ -z "$LINKS" ]] && continue

            FILE_DIR=$(dirname "$file")

            while IFS= read -r link; do
              [[ -z "$link" ]] && continue

              LINK_PATH=$(echo "$link" | cut -d'#' -f1)
              [[ -z "$LINK_PATH" ]] && continue

              CHECKED=$((CHECKED + 1))

              # Resolve path
              if [[ "$LINK_PATH" == /* ]]; then
                TARGET=".$LINK_PATH"
              else
                TARGET="$FILE_DIR/$LINK_PATH"
              fi

              if [[ ! -e "$TARGET" ]]; then
                echo "‚ùå Broken: $file -> $link"
                BROKEN=$((BROKEN + 1))
              fi
            done <<< "$LINKS"
          done

          echo ""
          echo "Links checked: $CHECKED"

          if [ "$BROKEN" -gt 0 ]; then
            echo "### ‚ùå Doc Links: $BROKEN broken" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Found $BROKEN broken documentation link(s)"
          else
            echo "### ‚úÖ Doc Links: All valid" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ All $CHECKED documentation links valid"
          fi
