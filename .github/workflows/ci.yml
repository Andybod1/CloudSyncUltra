name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-14

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Setup environment
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install rclone
        run: brew install rclone

      # Cache DerivedData for faster builds
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      # Install xcpretty if not available
      - name: Install xcpretty
        run: |
          if ! command -v xcpretty &> /dev/null; then
            gem install xcpretty
          fi

      # Build the project
      - name: Build
        run: |
          xcodebuild build \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            | xcpretty

      # Run tests with code coverage
      - name: Run Tests with Coverage
        run: |
          xcodebuild test \
            -project CloudSyncApp.xcodeproj \
            -scheme CloudSyncApp \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults \
            | xcpretty --report junit --output build/reports/junit.xml

      # Extract and report code coverage
      - name: Generate Coverage Report
        run: |
          # Find the xcresult bundle
          RESULT_BUNDLE="TestResults.xcresult"
          
          if [ -d "$RESULT_BUNDLE" ]; then
            echo "ðŸ“Š Code Coverage Report"
            echo "========================"
            
            # Get coverage percentage
            xcrun xccov view --report --only-targets "$RESULT_BUNDLE" > coverage_report.txt
            
            # Display coverage summary
            cat coverage_report.txt
            
            # Extract overall coverage percentage for CloudSyncApp target
            COVERAGE=$(xcrun xccov view --report --only-targets "$RESULT_BUNDLE" | grep "CloudSyncApp.app" | awk '{print $4}' | tr -d '%')
            
            echo ""
            echo "ðŸ“ˆ CloudSyncApp Coverage: ${COVERAGE}%"
            
            # Save coverage to file for artifact
            echo "$COVERAGE" > coverage_percentage.txt
            
            # Fail if coverage drops below threshold (optional - start with warning)
            THRESHOLD=30
            if [ ! -z "$COVERAGE" ]; then
              COVERAGE_INT=${COVERAGE%.*}
              if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
                echo "âš ï¸ Warning: Coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
                # Uncomment next line to fail CI on low coverage:
                # exit 1
              else
                echo "âœ… Coverage ($COVERAGE%) meets threshold ($THRESHOLD%)"
              fi
            fi
          else
            echo "âš ï¸ No test results found"
          fi

      # Generate detailed coverage JSON
      - name: Generate Coverage JSON
        if: always()
        run: |
          RESULT_BUNDLE="TestResults.xcresult"
          if [ -d "$RESULT_BUNDLE" ]; then
            xcrun xccov view --report --json "$RESULT_BUNDLE" > coverage.json
          fi

      # Check version consistency
      - name: Version Check
        run: |
          chmod +x ./scripts/version-check.sh
          ./scripts/version-check.sh

      # Upload test results and coverage
      - name: Upload Test Results & Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            build/reports/
            TestResults.xcresult/
            coverage_report.txt
            coverage_percentage.txt
            coverage.json
          retention-days: 14

      # Post coverage summary to PR (if PR)
      - name: Coverage Summary
        if: github.event_name == 'pull_request'
        run: |
          if [ -f coverage_percentage.txt ]; then
            COVERAGE=$(cat coverage_percentage.txt)
            echo "### ðŸ“Š Code Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See artifacts for detailed coverage report." >> $GITHUB_STEP_SUMMARY
          fi
